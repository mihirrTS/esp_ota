<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OTA Management - PersonalCMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .firmware-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: #f8f9fa;
        }
        .device-type-badge {
            font-size: 0.8em;
            padding: 4px 8px;
        }
        .stats-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            margin-bottom: 20px;
        }
        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .upload-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 20px;
        }
        .firmware-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('index') }}">
                <i class="fas fa-microchip"></i> PersonalCMS
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('index') }}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="nav-link active" href="{{ url_for('ota_management') }}">
                    <i class="fas fa-download"></i> OTA Management
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h1><i class="fas fa-download"></i> OTA Firmware Management</h1>
                <p class="text-muted">Manage over-the-air firmware updates for ESP32 devices</p>
            </div>
            <div class="col-auto">
                <a href="{{ url_for('ota_upload') }}" class="btn btn-primary">
                    <i class="fas fa-upload"></i> Upload Firmware
                </a>
            </div>
        </div>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Statistics Row -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ stats.total_firmware_versions }}</div>
                    <div>Total Firmware</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ stats.total_downloads }}</div>
                    <div>Total Downloads</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ stats.device_types|length }}</div>
                    <div>Device Types</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number">{{ ota_devices|length }}</div>
                    <div>OTA Devices</div>
                </div>
            </div>
        </div>

        <!-- Device Types Overview -->
        <div class="row mb-4">
            <div class="col">
                <div class="alert alert-success">
                    <h5><i class="fas fa-rocket"></i> Automatic Cross-Firmware Updates Enabled</h5>
                    <p class="mb-0">
                        <strong>ESP32 devices will automatically receive the latest firmware regardless of type.</strong><br>
                        When you upload a new firmware, all ESP32 devices will update to it on their next OTA check (every 2 minutes).
                        No manual intervention required - Base → LED Blink, PersonalCMS → Custom, etc.
                    </p>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-microchip"></i> Device Types</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            {% for device_type, info in stats.device_types.items() %}
                            <div class="col-md-4 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h6 class="card-title">{{ device_type }}</h6>
                                        <p class="card-text">
                                            <strong>Versions:</strong> {{ info.count }}<br>
                                            <strong>Downloads:</strong> {{ info.total_downloads }}<br>
                                            {% if info.latest_version %}
                                            <strong>Latest:</strong> v{{ info.latest_version.version }}
                                            {% endif %}
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Firmware Versions -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-code-branch"></i> Firmware Versions</h5>
                        <span class="badge bg-info">{{ firmware_versions|length }} versions</span>
                    </div>
                    <div class="card-body">
                        {% if firmware_versions %}
                            {% for firmware in firmware_versions %}
                            <div class="firmware-card">
                                <div class="row align-items-center">
                                    <div class="col-md-8">
                                        <h6 class="mb-1">
                                            <span class="badge bg-secondary device-type-badge">{{ firmware.device_type }}</span>
                                            <strong>Version {{ firmware.version }}</strong>
                                        </h6>
                                        <p class="mb-1 text-muted">{{ firmware.description or 'No description provided' }}</p>
                                        <small class="text-muted">
                                            <i class="fas fa-calendar"></i> {{ firmware.upload_date[:19] }}
                                            <i class="fas fa-hdd ms-3"></i> {{ "%.1f"|format(firmware.file_size / 1024 / 1024) }} MB
                                            <i class="fas fa-download ms-3"></i> {{ firmware.download_count or 0 }} downloads
                                        </small>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="firmware-actions">
                                            <a href="/api/ota/download/{{ firmware.key }}" class="btn btn-sm btn-outline-primary">
                                                <i class="fas fa-download"></i> Download
                                            </a>
                                            <button class="btn btn-sm btn-outline-danger" onclick="deleteFirmware('{{ firmware.key }}')">
                                                <i class="fas fa-trash"></i> Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                <h5>No firmware versions uploaded</h5>
                                <p class="text-muted">Upload your first firmware to get started with OTA updates.</p>
                                <a href="{{ url_for('ota_upload') }}" class="btn btn-primary">
                                    <i class="fas fa-upload"></i> Upload Firmware
                                </a>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- OTA Devices -->
        <div class="row mt-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-wifi"></i> OTA-Enabled Devices</h5>
                    </div>
                    <div class="card-body">
                        {% if ota_devices %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>Device ID</th>
                                            <th>Name</th>
                                            <th>Type</th>
                                            <th>Current Version</th>
                                            <th>Last Seen</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for device in ota_devices %}
                                        <tr>
                                            <td><code>{{ device.device_id }}</code></td>
                                            <td>{{ device.nickname or device.device_name or 'Unnamed' }}</td>
                                            <td>
                                                <span class="badge bg-info device-type-badge">
                                                    {{ device.device_type or 'ESP32' }}
                                                </span>
                                            </td>
                                            <td>
                                                {% if device.firmware_version %}
                                                    <code>{{ device.firmware_version }}</code>
                                                {% else %}
                                                    <span class="text-muted">Unknown</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if device.last_seen %}
                                                    {{ device.last_seen.strftime('%Y-%m-%d %H:%M') }}
                                                {% else %}
                                                    <span class="text-muted">Never</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if device.is_active %}
                                                    <span class="badge bg-success">Online</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">Offline</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <a href="{{ url_for('ota_device_detail', device_id=device.device_id) }}" 
                                                   class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-info-circle"></i> Details
                                                </a>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-wifi fa-3x text-muted mb-3"></i>
                                <h5>No OTA-enabled devices found</h5>
                                <p class="text-muted">Devices will appear here once they connect with OTA support.</p>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function deleteFirmware(firmwareKey) {
            if (confirm('Are you sure you want to delete this firmware version? This action cannot be undone.')) {
                fetch(`/api/ota/delete/${firmwareKey}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Failed to delete firmware: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error deleting firmware: ' + error);
                });
            }
        }

        // Auto-refresh device status every 30 seconds
        setInterval(() => {
            location.reload();
        }, 30000);
    </script>
</body>
</html>